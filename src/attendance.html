<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900&display=swap"
      rel="stylesheet"
    />
    <title>Attendance Tracker</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: "Poppins", sans-serif;
        background-color: #f5f5f5;
      }

      h1 {
        font-size: 5rem;
        text-align: center;
        margin-top: 20px;
        color: #333;
      }

      #datetime {
        position: fixed;
        top: 20px;
        right: 20px;
        font-size: 3rem;
        color: #4d3cf0;
        font-weight: bold;
      }

      table {
        font-size: 3rem;
        margin: 0 auto; /* Center the table horizontally */
        border-collapse: collapse;
        width: 85%;
        background-color: #fff;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
      }

      th,
      td {
        padding: 15px;
        text-align: center;
        border-bottom: 1px solid #ddd;
      }

      th {
        background-color: #4d3cf0;
        color: white;
      }

      tr:nth-child(even) {
        background-color: #f9f9f9;
      }

      tr:hover {
        background-color: #f1f1f1;
      }

      /* Input area styling */
      #qrInput {
        display: block;
        margin: 20px auto;
        padding: 10px;
        font-size: 2rem;
        width: 85%;
        border: 2px solid #4d3cf0;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      #qrInput:focus {
        outline: none;
        border-color: #3b28c6;
      }

      #downloadBtn {
        display: block;
        margin: 20px auto;
        padding: 10px 20px;
        background-color: #4d3cf0;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 2.5rem;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      #downloadBtn:hover {
        background-color: #3b28c6;
      }

      #myModal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      #modalContent {
        background-color: white;
        margin: 15% auto;
        padding: 20px;
        width: 40%;
        border-radius: 10px;
        text-align: center;
      }

      #modalContent label {
        font-size: 3rem;
        margin: 10px;
        display: block;
      }

      #modalContent button {
        margin-top: 20px;
        padding: 10px 20px;
        font-size: 2.4rem;
        background-color: #4d3cf0;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      #modalContent button:hover {
        background-color: #3b28c6;
      }
    </style>
  </head>
  <body>
    <!-- Logo section -->
    <div style="position: absolute; top: 20px; left: 20px">
      <img src="../src/assets/logo-light.png" alt="Logo" width="250" />
    </div>

    <!-- Date and Time -->
    <div id="datetime"></div>

    <h1>Attendance</h1>

    <!-- QR Input field -->
    <textarea id="qrInput" placeholder="Scan your QR Code here"></textarea>
    <div
      id="message"
      style="color: red; text-align: center; margin-top: 10px; font-size: 2rem"
    ></div>
    <button id="downloadBtn">Download CSV</button>

    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Section</th>
          <!-- <th>Year</th> -->
          <th>Timestamp</th>
        </tr>
      </thead>
      <tbody id="attendance-body">
        <!-- Existing table rows -->
      </tbody>
    </table>

    <div id="myModal">
      <div id="modalContent">
        <h2>Select Section to Download</h2>
        <label><input type="radio" name="section" value="ITR3" /> ITR3</label>
        <label><input type="radio" name="section" value="ITR5" /> ITR5</label>
        <label><input type="radio" name="section" value="ITR6" /> ITR6</label>
        <label><input type="radio" name="section" value="ITR7" /> ITR7</label>
        <button id="confirmDownload">Download CSV</button>
        <button class="cancel" id="cancelDownload">Cancel</button>
      </div>
    </div>

    <script>
      let scanTimeout;
      let attendanceData = [];

      // Function to update the date and time
      function updateDateTime() {
        const now = new Date();
        const options = {
          weekday: "short",
          year: "numeric",
          month: "short",
          day: "numeric",
        };
        const formattedDate = now.toLocaleDateString("en-US", options);
        document.getElementById("datetime").textContent = formattedDate;
      }

      // Call the function to set the date and time when the page loads
      window.onload = function () {
        updateDateTime();
      };

      // Function to show the modal
      function showModal() {
        document.getElementById("myModal").style.display = "block";
      }

      // Function to hide the modal
      function hideModal() {
        document.getElementById("myModal").style.display = "none";
      }

      // Load CSV data (dummy function, replace with actual logic)
      function loadCSV(onComplete, onError) {
        const csvFilePath = "List-of-Students.csv";
        Papa.parse(csvFilePath, {
          download: true,
          header: true,
          complete: function (results) {
            onComplete(results.data);
          },
          error: function (error) {
            console.error("Error parsing CSV:", error);
            if (onError) onError(error);
          },
        });
      }

      function isIdAlreadyInTable(id) {
        const tableBody = document.getElementById("attendance-body");
        const rows = tableBody.getElementsByTagName("tr");

        for (let i = 0; i < rows.length; i++) {
          const rowId = rows[i].getElementsByTagName("td")[0].textContent;
          if (rowId === id) {
            return true; // ID found in table
          }
        }
        return false; // ID not found in table
      }

      function displayMessage(msg, isError = true) {
        const messageDiv = document.getElementById("message");
        messageDiv.textContent = msg;
        messageDiv.style.color = isError ? "red" : "green";
        setTimeout(() => {
          messageDiv.textContent = ""; // Clear the message after 3 seconds
        }, 3000);
      }

      // Function to add a scanned student to the table
      function addStudentToTable(id, name, section) {
        if (isIdAlreadyInTable(id)) {
          displayMessage(
            "Student with ID " + id + " is already marked as present."
          );
          return; // Exit the function to prevent duplicate entry
        }

        const timestamp = new Date().toLocaleString("en-US", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          hour12: true,
        });

        const tableBody = document.getElementById("attendance-body");

        const newRow = document.createElement("tr");
        newRow.innerHTML = `
        <td>${id}</td>
        <td>${name}</td>
        <td>${section}</td>
        <td>${timestamp}</td>
      `;

        tableBody.appendChild(newRow);
        attendanceData.push({ id, name, section, timestamp });
        displayMessage("Student with ID " + id + " successfully added.", false);
      }

      function downloadCSV(section) {
        const filteredData = attendanceData.filter(
          (e) => e.section === section
        );

        const csvContent =
          "data:text/csv;charset=utf-8," +
          ["ID,Name,Section,Timestamp"].join(",") +
          "\n" +
          filteredData
            .map((e) => `${e.id},${e.name},${e.section},${e.timestamp}`)
            .join("\n");

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `attendance_data_${section}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link); // Clean up

        hideModal(); // Close the modal after downloading
      }

      document
        .getElementById("downloadBtn")
        .addEventListener("click", function () {
          showModal(); // Show the modal when clicking download button
        });
      document
        .getElementById("cancelDownload")
        .addEventListener("click", function () {
          hideModal();
        });

      document
        .getElementById("confirmDownload")
        .addEventListener("click", function () {
          const selectedSection = document.querySelector(
            'input[name="section"]:checked'
          ).value;
          if (selectedSection) {
            downloadCSV(selectedSection);
          }
        });

      // document
      //   .getElementById("downloadBtn")
      //   .addEventListener("click", downloadCSV);

      // QR Code input listener
      document
        .getElementById("qrInput")
        .addEventListener("input", function (event) {
          clearTimeout(scanTimeout);

          scanTimeout = setTimeout(() => {
            const input = event.target.value.trim(); // Trim any leading/trailing whitespace

            // Extract the 10-digit ID
            const idMatch = input.match(/\d{10}/);

            if (idMatch) {
              const id = idMatch[0];

              // Load and validate ID against CSV data
              loadCSV(function (data) {
                const student = data.find((student) => student.id === id);

                if (student) {
                  document.getElementById("qrInput").value = "";
                  addStudentToTable(id, student.name, student.section); // Add student to table
                } else {
                  event.target.value = ""; // Clear input field for invalid ID
                  event.target.placeholder = "Invalid ID. Scan again.";
                }
              });
            } else {
              event.target.value = ""; // Clear input field for invalid ID
              event.target.placeholder = "Invalid ID. Scan again.";
            }
          }, 500);
        });
    </script>
  </body>
</html>
